#!/bin/bash
set -e  # Fail fast on errors

# Check if running in GitHub Actions release workflow
GITHUB_RELEASE=false
if [[ "$GITHUB_REF_TYPE" == "tag" ]]; then
    GITHUB_RELEASE=true
fi

# Check for uncommitted changes (both modified and untracked files) â€“ only for local builds
is_dirty="false"
if [[ "$GITHUB_RELEASE" == "false" ]]; then
    if ! git diff --quiet HEAD -- || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
        is_dirty="true"
    fi

    if [ "$is_dirty" = "true" ]; then
    if [ -t 0 ]; then  # Only prompt if running in an interactive shell
        read -r -p "There are uncommitted changes. Are you sure you want to build? (Y/n) " user_input
        user_input=$(echo "$user_input" | tr '[:upper:]' '[:lower:]')
        if [[ "$user_input" == "n" || "$user_input" == "no" ]]; then
            echo "Build aborted."
            exit 1
        fi
    else
        echo "WARNING: Uncommitted changes detected, but skipping prompt due to non-interactive mode."
    fi
fi
fi

# Function to get version information
get_version_info() {
    local latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
    latest_tag=$(echo "$latest_tag" | sed 's/^v//')

    if [[ "$GITHUB_RELEASE" == "true" ]]; then
        echo "$latest_tag"
        return
    fi

    local current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    local commit_hash=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")

    if [ "$is_dirty" = "true" ]; then
        commit_hash="dirty"
    fi

    if git describe --exact-match --tags >/dev/null 2>&1 && [ "$is_dirty" = "false" ]; then
        version="$latest_tag"
    else
        version="${latest_tag}+${current_branch}.${commit_hash}"
    fi

    echo "$version"
}

# Get version info
VERSION=$(get_version_info)
echo "Building version: $VERSION"

# Validate required directories
if [ ! -d "bng-cc-core/lib" ]; then
    echo "ERROR: Required directory 'bng-cc-core/lib' not found!"
    exit 1
fi

# Create version.lua
cat >bng-cc-core/lib/version.lua <<EOL
-- Generated by build script
return {
    VERSION = '${VERSION}',
    COMMIT = '$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")',
    BRANCH = '$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")',
    BUILD_DATE = '$(date '+%Y-%m-%d %H:%M:%S')'
}
EOL

# Create dist directory
mkdir -p dist
rm -rf dist/*

# Ensure globstar is enabled for recursive globbing
shopt -s globstar

### CORE MODULE BUNDLING ###
# Build core bundle
echo "Building core bundle..."
cd bng-cc-core || { echo "ERROR: Core directory missing!"; exit 1; }

# Collect all core modules, but exclude only the top-level init.lua
CORE_MODULES=$(find lib -type f -name "*.lua" ! -path "lib/init.lua" | sed -E 's|lib/||; s|/|.|g; s|.lua$||g')

echo "Found core modules:"
echo "$CORE_MODULES"

# Use luacc to bundle core modules
luacc -o ../dist/bng-cc-core.lua -i lib init $CORE_MODULES

cd ..

# Verify core bundle was created
if [ ! -f "dist/bng-cc-core.lua" ]; then
    echo "ERROR: Core bundle creation failed"
    exit 1
fi

### VENDOR MODULE BUNDLING ###
echo 'Building vendor bundle...'

cd bng-cc-core/vendor || { echo "ERROR: Vendor directory missing!"; exit 1; }

# Collect all vendor modules, but exclude only the top-level init.lua
VENDOR_MODULES=$(find . -type f -name "*.lua" ! -path "./init.lua" | sed -E 's|^./||; s|/|.|g; s|.lua$||g')

echo "Found vendor modules:"
echo "$VENDOR_MODULES"

# Use correct LuaCC bundling format
luacc -o ../../dist/vendor.lua -i . init $VENDOR_MODULES

cd ../..

# Ensure vendor.lua was created
if [ ! -f "dist/vendor.lua" ]; then
    echo "ERROR: Vendor bundle creation failed"
    exit 1
fi

# Minify both core and vendor (if vendor exists)
echo 'Minifying Lua bundles...'
mkdir -p dist/release

for file in "bng-cc-core" "vendor"; do
    if [ -f "dist/${file}.lua" ]; then
        echo "-- ${file} by bngarren" >dist/release/${file}.min.lua
        echo "-- MIT License" >>dist/release/${file}.min.lua
        echo "-- Version $VERSION" >>dist/release/${file}.min.lua
        echo "-- Generated $(date '+%Y-%m-%d %H:%M:%S')" >>dist/release/${file}.min.lua

        CONTENT=$(cat dist/${file}.lua)
        if [ -n "$CONTENT" ]; then

            if ! command -v luamin &>/dev/null; then
                echo "ERROR: 'luamin' command not found. Install it via luarocks."
                exit 1
            fi

            echo "$CONTENT" | luamin -c >>dist/release/${file}.min.lua
        else
            echo "ERROR: No content to minify for $file"
            exit 1
        fi
    fi
done

echo "Build complete! Output files:"
ls -lh dist/release/
